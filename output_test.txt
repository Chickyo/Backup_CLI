PS D:\Nam_4\anToanVaPhucHoiDuLieu\LAB CLI\source\Backup_CLI> bash tests/run_all_tests.sh
==================
RUNNING ALL TESTS
==================
=== TEST TAMPERING ===
[1] Init và Backup dữ liệu gốc...
 -> Snapshot ID: 1767963096_3085
[2] Verify lần đầu (Mong đợi: OK)...
Verifying snapshot 1767963096_3085...
Checking rollback protection (roots.log)...
Verifying roots.log hash chain...
VERIFY OK.
[3] Tấn công: Sửa đổi 1 byte trong chunk...
 -> Corrupting chunk: store/chunks/21d506a93a64490e04ccd1e61be12cac8f087cbbffcf4d89e5b5bf6e4d2820bd
[4] Verify sau khi sửa chunk (Mong đợi: FAIL)...
Verifying snapshot 1767963096_3085...
VERIFY FAIL: Chunk 21d506a93a64490e04ccd1e61be12cac8f087cbbffcf4d89e5b5bf6e4d2820bd is corrupted (hash mismatch)
PASS: Hệ thống phát hiện được sửa đổi chunk!
=== KẾT THÚC TEST TAMPER ===
----------------------------------------
=== TEST MANIFEST TAMPERING ===
[1] Creating backup...
 -> Snapshot ID: 1767963097_3517
[2] Verifying original snapshot...
Verifying snapshot 1767963097_3517...
Checking rollback protection (roots.log)...
Verifying roots.log hash chain...
VERIFY OK.
[3] Tampering with manifest.json...
[4] Verifying tampered snapshot...
Verifying snapshot 1767963097_3517...
VERIFY FAIL: Exception Extra data: line 1 column 82 (char 81)
PASS: Hệ thống phát hiện được sửa đổi manifest!
=== MANIFEST TAMPER TEST COMPLETED ===
----------------------------------------
=== TEST ROLLBACK PROTECTION ===
 -> Created Old Snapshot: 1767963097_9639
 -> Created New Snapshot: 1767963099_2225

[Before Attack] Verify snapshot mới - Mong đợi: OK...
Verifying snapshot 1767963099_2225...
Checking rollback protection (roots.log)...
Verifying roots.log hash chain...
VERIFY OK.

[ROLLBACK ATTACK] Thay thế snapshot mới (1767963099_2225) bằng snapshot cũ (1767963097_9639)...

[After Attack] Verify snapshot 1767963099_2225 - Mong đợi: FAIL (rollback detected)...     
Verifying snapshot 1767963099_2225...
VERIFY FAIL: Snapshot ID mismatch! Folder name is '1767963099_2225' but metadata.json has ID '1767963097_9639' (rollback attack detected)!

PASS: Hệ thống phát hiện được ROLLBACK ATTACK!

=== KẾT THÚC TEST ROLLBACK ===
----------------------------------------
=== TEST AUDIT LOG INTEGRITY ===
Generating logs...
[1] Checking valid audit log...
Verifying audit log...
AUDIT OK. Head Hash: 7f622ec40318f0022e2343baae228d41cc45e74bf0cf83384cce5737d88eb246      
[2] Attacking audit log...
[3] Verifying tampered log...
Verifying audit log...
AUDIT CORRUPTED at line 2: Content modified.
PASS: Phát hiện sửa đổi Audit Log thành công!
----------------------------------------
=== TEST CRASH RECOVERY (JOURNAL) ===
-> Đã tạo giả lập crash: Snapshot 9999999999 chưa commit.
Running list-snapshots to trigger recovery...
PASS: Crash Recovery hoạt động tốt (Snapshot lỗi đã bị xoá).
----------------------------------------
=== TEST POLICY ===

[TEST 1] Admin Permission Test
User: ubuntu, Role: admin
Running: python3 -m src.main init store
Output: Initialized store at store
Exit Code: 0
PASS: Admin có quyền init
.
[TEST 2] Auditor Denial Test
User: ubuntu, Role: auditor
Running: python3 -m src.main init store
Output: PERMISSION DENIED: User 'ubuntu' cannot run 'init'
Exit Code: 1
PASS: Auditor bị từ chối init (đúng như mong đợi)
.
[TEST 3] Operator Permission Test
User: ubuntu, Role: operator

[3a] Testing backup permission (should succeed)...
Running: python3 -m src.main backup dataset_operator --label 'Op test'
Output: Snapshot 1767963101_5784 created successfully. Root: d4b26f060ef6...
Exit Code: 0
PASS: Operator có quyền backup

[3b] Testing init denial (should fail)...
Running: python3 -m src.main init store
Output: PERMISSION DENIED: User 'ubuntu' cannot run 'init'
Exit Code: 1
PASS: Operator bị từ chối init (đúng như mong đợi)
.
----------------------------------------------------------------------
Ran 3 tests in 0.557s

OK
----------------------------------------
=== GENERATING 2000 FILES IN dataset_test ===
Generating files...
  -> Created 200 files...
  -> Created 400 files...
  -> Created 600 files...
  -> Created 800 files...
  -> Created 1000 files...
  -> Created 1200 files...
  -> Created 1400 files...
  -> Created 1600 files...
  -> Created 1800 files...
  -> Created 2000 files...
=== GENERATION COMPLETE ===
Total files: 2000
----------------------------------------
========================================
=== TEST RESTORE & COMPARE PROJECT ===
========================================
[1] Creating backup of dataset_test...
Snapshot 1767963168_3043 created successfully. Root: 37944505bdc7...
 -> Snapshot ID: 1767963168_3043
[2] Creating backup copy for comparison...
 -> Original file count: 2000
[3] Computing checksums of original files...
[4] Deleting 30% of files from dataset_test...
 -> Deleting first 5 directories...
    Removing: dataset_test/folder_1
    Removing: dataset_test/folder_10
    Removing: dataset_test/folder_2
    Removing: dataset_test/folder_3
    Removing: dataset_test/folder_4
 -> Files after deletion: 762 (deleted: 1238)
[5] Restoring from snapshot 1767963168_3043...
Verifying snapshot 1767963168_3043...
Checking rollback protection (roots.log)...
Verifying roots.log hash chain...
VERIFY OK.
Restoring snapshot 1767963168_3043 to dataset_test_restored...
Restore completed.
 -> Restored file count: 2000
PASS: File count matches (2000)
[6] Comparing directory structure...
PASS: Directory structure identical
[7] Comparing file contents (checksum)...
PASS: All file contents match (checksums identical)
[8] Deep comparison with diff -r...
PASS: Deep comparison successful - all files identical

=== CLEANUP SECTION ===
Bạn có muốn xóa các thư mục tạm và file checksum không? (y/n): n
Đã giữ lại các thư mục để bạn kiểm tra thủ công.
----------------------------------------
DONE.